---
name: Validate pull request
on:
  workflow_call:
    inputs:
      base_ref:
        description: 'Base branch reference'
        required: true
        type: string

jobs:
  # Check if src/pages files were changed
  check-files:
    runs-on: ubuntu-latest
    outputs:
      run_validation: ${{ steps.filter.outputs.run_validation }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for src/pages changes
        id: filter
        run: |
          git fetch origin ${{ inputs.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ inputs.base_ref }}...HEAD)
          if echo "$CHANGED_FILES" | grep -q "^src/pages/"; then
            echo "run_validation=true" >> $GITHUB_OUTPUT
            echo "✅ Changes detected in src/pages/"
          else
            echo "run_validation=false" >> $GITHUB_OUTPUT
            echo "⏭️ No changes in src/pages/, skipping validation"
          fi

  toc:
    needs: check-files
    if: needs.check-files.outputs.run_validation == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run TOC validation
        run: npm run test:config

  markdown-lint:
    needs: [check-files, toc]
    if: needs.check-files.outputs.run_validation == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Markdown lint
        run: npm run lint:md

  remark-lint:
    needs: [check-files, markdown-lint]
    if: needs.check-files.outputs.run_validation == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint DevSite Utils
        run: npm run lint

  # Gate job that always runs and becomes the required check
  validate-pr:
    runs-on: ubuntu-latest
    needs: [check-files, toc, markdown-lint, remark-lint]
    if: always()
    steps:
      - name: Check validation results
        run: |
          # If no src/pages files changed, pass automatically
          if [[ "${{ needs.check-files.outputs.run_validation }}" == "false" ]]; then
            echo "✅ No src/pages/ files changed - validation skipped"
            exit 0
          fi
          
          # If src/pages files changed, check that all validation jobs succeeded
          if [[ "${{ needs.toc.result }}" == "success" ]] && \
             [[ "${{ needs.markdown-lint.result }}" == "success" ]] && \
             [[ "${{ needs.remark-lint.result }}" == "success" ]]; then
            echo "✅ All validation checks passed"
            exit 0
          else
            echo "❌ One or more validation checks failed"
            echo "TOC: ${{ needs.toc.result }}"
            echo "Markdown Lint: ${{ needs.markdown-lint.result }}"
            echo "Remark Lint: ${{ needs.remark-lint.result }}"
            exit 1
          fi
