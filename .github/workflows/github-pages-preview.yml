---
name: GitHub Pages preview
on:
  workflow_call:
    inputs:
      branch:
        description: "Branch to deploy"
        type: string
        required: false
        default: ""
    outputs:
      page_url:
        description: "The deployed GitHub Pages URL"
        value: ${{ jobs.deploy.outputs.page_url }}

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      PATH_PREFIX: ${{ github.event.repository.name }}
    steps:
      - name: Checkout content repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}
          path: content

      - name: Read site config
        id: config
        run: |
          SITE_PATH=$(node -p "require('./content/package.json').config.sitePath")
          
          # Validate sitePath format (alphanumeric, slashes, hyphens, underscores only - no shell metacharacters)
          if ! echo "$SITE_PATH" | grep -qE '^[a-zA-Z0-9/_-]+$'; then
            echo "ERROR: Invalid sitePath format in package.json. Must contain only alphanumeric characters, slashes, hyphens, or underscores."
            exit 1
          fi
          
          # Strip leading slash if present, then extract first path segment
          SITE_PREFIX=$(echo "$SITE_PATH" | sed 's|^/||' | cut -d'/' -f1)
          echo "SITE_PATH=$SITE_PATH" >> $GITHUB_ENV
          echo "SITE_PREFIX=$SITE_PREFIX" >> $GITHUB_ENV
          echo "site_path=$SITE_PATH" >> $GITHUB_OUTPUT
          echo "✓ Site path validated: $SITE_PATH (prefix: $SITE_PREFIX)"

      - name: Clone adp-devsite
        uses: actions/checkout@v4
        with:
          repository: AdobeDocs/adp-devsite
          path: adp-devsite

      - name: Clone devsite-runtime-connector
        uses: actions/checkout@v4
        with:
          repository: aemsites/devsite-runtime-connector
          path: devsite-runtime-connector

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/jod"

      - name: Install dependencies
        run: |
          cd content && npm install
          cd ../adp-devsite && npm install
          cd ../devsite-runtime-connector && npm install

      - name: Start development servers
        run: |
          ROOT_DIR=$(pwd)
          
          # Start content server (port 3003)
          (cd "$ROOT_DIR/content" && npm run dev > "$ROOT_DIR/content-server.log" 2>&1) &
          echo $! > /tmp/content.pid
          
          # Start adp-devsite (port 3000)
          (cd "$ROOT_DIR/adp-devsite" && npm run dev > "$ROOT_DIR/devsite-server.log" 2>&1) &
          echo $! > /tmp/devsite.pid
          
          # Start runtime connector (port 3001)
          (cd "$ROOT_DIR/devsite-runtime-connector" && npm run dev > "$ROOT_DIR/connector-server.log" 2>&1) &
          echo $! > /tmp/connector.pid
          
          echo "Servers starting in background..."

      - name: Wait for servers to be ready
        run: |
          echo "Waiting for servers..."
          for port in 3000 3003; do
            for i in {1..60}; do
              if curl -s "http://localhost:$port" > /dev/null 2>&1; then
                echo "✓ Port $port is ready"
                break
              fi
              if [ $i -eq 60 ]; then
                echo "✗ Port $port timeout"
                exit 1
              fi
              sleep 1
            done
          done
          
          # Verify site is accessible
          curl -sf "http://localhost:3000/${SITE_PATH}/" > /dev/null && echo "✓ Site is accessible"

      - name: Generate static site with wget
        run: |
          ROOT_DIR=$(pwd)
          mkdir -p "$ROOT_DIR/_site"
          
          # Generate URL list from markdown files
          cd "$ROOT_DIR/content"
          find src/pages -name "*.md" | sed 's|src/pages/||' | sed 's|\.md$||' | sed 's|/index$|/|' | while read path; do
            echo "http://localhost:3000/${SITE_PATH}/$path"
          done > "$ROOT_DIR/urls.txt"
          
          echo "Crawling $(wc -l < "$ROOT_DIR/urls.txt" | tr -d ' ') pages..."
          
          cd "$ROOT_DIR/_site"
          wget \
            --input-file="$ROOT_DIR/urls.txt" \
            --page-requisites \
            --adjust-extension \
            --convert-links \
            --restrict-file-names=windows \
            --domains localhost \
            --execute robots=off \
            --wait=0.1 \
            --tries=3 \
            --timeout=30 \
            --quiet \
            2>&1 || true
          
          echo "✓ wget crawl complete"

      - name: Copy static assets
        run: |
          cd _site
          
          # Copy hlx_statics from adp-devsite source
          mkdir -p localhost+3000/hlx_statics
          cp -r ../adp-devsite/hlx_statics/* localhost+3000/hlx_statics/
          echo "✓ Copied $(find localhost+3000/hlx_statics -type f | wc -l | tr -d ' ') static files"

      - name: Fetch API endpoints
        run: |
          cd _site
          mkdir -p "localhost+3000/${SITE_PATH}"
          mkdir -p localhost+3000/franklin_assets
          
          # Config (for side navigation)
          curl -sf "http://localhost:3000/${SITE_PATH}/config" -o "localhost+3000/${SITE_PATH}/config" && echo "✓ config"
          
          # Footer
          curl -sf "http://localhost:3000/franklin_assets/footer.plain.html" -o localhost+3000/franklin_assets/footer.plain.html && echo "✓ footer"
          
          # Product index map
          curl -sf "http://localhost:3000/franklin_assets/product-index-map.json" -o localhost+3000/franklin_assets/product-index-map.json && echo "✓ product-index-map"
          
          # Site-wide banner
          curl -sf "http://localhost:3000/${SITE_PATH}/site-wide-banner.json" -o "localhost+3000/${SITE_PATH}/site-wide-banner.json" || echo "○ site-wide-banner (optional)"

      - name: Rewrite paths for GitHub Pages
        run: |
          cd _site
          
          # Rewrite config paths for side-nav filtering
          CONFIG_FILE="localhost+3000/${SITE_PATH}/config"
          if [ -f "$CONFIG_FILE" ]; then
            # Rewrite the main site path
            perl -i -pe "s|href=\"/${SITE_PATH}/|href=\"/${PATH_PREFIX}/${SITE_PATH}/|g" "$CONFIG_FILE"
            
            # Extract unique top-level nav paths from config.md pages section
            # Looks for patterns like [Label](/path/...) and extracts the first directory segment
            # Uses \Q...\E to escape regex metacharacters in nav_path
            grep -oE '\]\(/[^/)]+/' ../content/src/pages/config.md | \
              sed 's/](//' | \
              sort -u | while read nav_path; do
                perl -i -pe "s|\Qhref=\"${nav_path}\E|href=\"/${PATH_PREFIX}/${SITE_PATH}${nav_path}|g" "$CONFIG_FILE"
              done
            
            echo "✓ Config paths rewritten"
          fi

      - name: Organize output structure
        run: |
          cd _site
          
          # Move content from localhost+3000 to root
          if [ -d "localhost+3000" ]; then
            mv localhost+3000/* . 2>/dev/null || true
            rm -rf localhost+3000
            echo "✓ Output structure organized"
          fi

      - name: Fix superhero block images
        run: |
          cd _site
          
          # The superhero.js expects <picture><img></picture> but we have plain <img>
          # Wrap superhero images in <picture> elements so the background works
          if [ -f "${SITE_PATH}/index.html" ]; then
            # Find <img> tags in superhero blocks and wrap them in <picture>
            perl -i -0pe 's|(<div class="superhero">.*?<div>\s*)<img ([^>]+)>(.*?</div>\s*</div>)|$1<picture><img $2></picture>$3|gs' "${SITE_PATH}/index.html"
            echo "✓ Superhero images wrapped in <picture>"
          fi

      - name: Inject GitHub Pages interceptor
        run: |
          cd _site
          
          # Security: Hardcoded trusted source for the interceptor script
          # This prevents any user input from controlling where code is fetched from
          TRUSTED_REPO="AdobeDocs/commerce-contributor"
          
          # Try local file first (for when this repo uses the workflow)
          LOCAL_SCRIPT="../content/.github/scripts/gh-pages-interceptor.js"
          
          if [ -f "$LOCAL_SCRIPT" ]; then
            echo "Using local interceptor script: $LOCAL_SCRIPT"
            INTERCEPTOR=$(cat "$LOCAL_SCRIPT" | sed "s/__PATH_PREFIX__/$PATH_PREFIX/g" | sed "s/__SITE_PREFIX__/$SITE_PREFIX/g" | tr '\n' ' ' | sed 's/  */ /g')
          else
            # Fetch from the hardcoded trusted source
            SCRIPT_URL="https://raw.githubusercontent.com/${TRUSTED_REPO}/main/.github/scripts/gh-pages-interceptor.js"
            echo "Fetching interceptor from trusted source: $SCRIPT_URL"
            INTERCEPTOR=$(curl -sf "$SCRIPT_URL" | sed "s/__PATH_PREFIX__/$PATH_PREFIX/g" | sed "s/__SITE_PREFIX__/$SITE_PREFIX/g" | tr '\n' ' ' | sed 's/  */ /g')
          fi
          
          if [ -z "$INTERCEPTOR" ]; then
            echo "ERROR: Failed to load interceptor script"
            exit 1
          fi
          
          # Create script tag
          echo "<script>${INTERCEPTOR}</script>" > /tmp/interceptor.txt
          
          # Inject into all HTML files
          find . -name "*.html" -type f | while read htmlfile; do
            perl -i -pe 'BEGIN{open(F,"/tmp/interceptor.txt");$s=<F>;chomp $s;close F} s/<head>/<head>$s/' "$htmlfile" 2>/dev/null || true
          done
          
          MODIFIED=$(grep -l "$PATH_PREFIX" "${SITE_PATH}"/*.html 2>/dev/null | wc -l | tr -d ' ')
          echo "✓ Interceptor injected into $MODIFIED files"

      - name: Add security headers
        run: |
          cd _site
          
          # Content Security Policy to mitigate XSS attacks
          # - 'self' allows resources from same origin
          # - 'unsafe-inline' required for the interceptor script and inline styles
          # - data: allows data URIs for images (used by some frameworks)
          # - blob: allows blob URIs (used for dynamic content)
          # - https: restricts external resources to HTTPS only
          CSP_CONTENT="default-src 'self'; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:; frame-ancestors 'self';"
          CSP_TAG="<meta http-equiv=\"Content-Security-Policy\" content=\"${CSP_CONTENT}\">"
          
          # X-Content-Type-Options to prevent MIME sniffing
          XCTO_TAG="<meta http-equiv=\"X-Content-Type-Options\" content=\"nosniff\">"
          
          # Referrer-Policy for privacy
          RP_TAG="<meta name=\"referrer\" content=\"strict-origin-when-cross-origin\">"
          
          # Combine security meta tags
          SECURITY_TAGS="${CSP_TAG}${XCTO_TAG}${RP_TAG}"
          
          # Inject security headers into all HTML files (after <head>)
          find . -name "*.html" -type f | while read htmlfile; do
            # Check if CSP already exists to avoid duplicates
            if ! grep -q "Content-Security-Policy" "$htmlfile" 2>/dev/null; then
              perl -i -pe "s|<head>|<head>${SECURITY_TAGS}|" "$htmlfile" 2>/dev/null || true
            fi
          done
          
          SECURED=$(grep -l "Content-Security-Policy" "${SITE_PATH}"/*.html 2>/dev/null | wc -l | tr -d ' ')
          echo "✓ Security headers added to $SECURED files"

      - name: Create root redirect
        run: |
          cd _site
          cat > index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'none'; style-src 'unsafe-inline'; img-src 'none'; frame-ancestors 'self';">
            <meta http-equiv="X-Content-Type-Options" content="nosniff">
            <meta name="referrer" content="strict-origin-when-cross-origin">
            <title>Preview</title>
          HTMLEOF
          # Add dynamic content with proper escaping
          echo "    <meta http-equiv=\"refresh\" content=\"0; url=${SITE_PATH}/\">" >> index.html
          echo "    <link rel=\"canonical\" href=\"${SITE_PATH}/\">" >> index.html
          cat >> index.html << 'HTMLEOF'
          </head>
          <body>
          HTMLEOF
          echo "    <p>Redirecting to <a href=\"${SITE_PATH}/\">documentation</a>...</p>" >> index.html
          cat >> index.html << 'HTMLEOF'
          </body>
          </html>
          HTMLEOF
          echo "✓ Root redirect created with security headers"

      - name: Stop servers
        if: always()
        run: |
          for pidfile in /tmp/content.pid /tmp/devsite.pid /tmp/connector.pid; do
            if [ -f "$pidfile" ]; then
              kill $(cat "$pidfile") 2>/dev/null || true
            fi
          done

      - name: Verify build output
        run: |
          cd _site
          echo "=== Build Summary ==="
          echo "Total files: $(find . -type f | wc -l | tr -d ' ')"
          echo "HTML files: $(find . -name '*.html' | wc -l | tr -d ' ')"
          
          if [ ! -d "${SITE_PATH}" ]; then
            echo "ERROR: No content generated!"
            exit 1
          fi
          
          echo "✓ Build verification passed"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    name: Deploy
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
